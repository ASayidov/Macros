Упрощение вставки изображений из Телеграм в Excel-отчёт с помощью макроса
1. Создание Личной книги макросов (PERSONAL.XLSB)
Открываем Excel.
Если вкладка Разработчик (Developer) не отображается:
Нажимаем Файл > Параметры > Настройка ленты.
Ставим галочку на «Разработчик» и нажимаем OK.
Запускаем запись пустого макроса:
На вкладке Разработчик нажимаем Запись макроса (Record Macro).
В поле «Сохранить макрос в» (Store macro in) выбираем Личная книга макросов (Personal Macro Workbook).
Даём любое имя (например, TempMacro) и нажимаем OK.
Останавливаем запись:
На вкладке Разработчик нажимаем Остановить запись (Stop Recording).
Таким образом Excel автоматически создаст файл PERSONAL.XLSB и сохранит ваш пробный макрос.
Закрываем Excel, чтобы убедиться, что PERSONAL.XLSB сохранён.
При повторном открытии Excel файл PERSONAL.XLSB загружается в фоновом режиме автоматически.
Примечание: Если PERSONAL.XLSB уже существует, этот шаг можно пропустить.

2. Открытие и подготовка PERSONAL.XLSB
Снова запускаем Excel.
Нажимаем Alt + F11, чтобы открыть редактор VBA.
Слева, в Project Explorer, ищем книгу PERSONAL.XLSB. Она обычно подписана как:

VBAProject (PERSONAL.XLSB)
Раскрываем Modules (модули). Если там ещё нет нужного модуля, можно добавить:
Вставка (Insert) > Module.
3. Вставка макроса PasteIntoRange
Теперь нам нужно разместить код макроса в PERSONAL.XLSB, чтобы он был доступен во всех книгах Excel.

Код макроса
Ниже приведён макрос, который вставляет картинку из буфера обмена в выбранный диапазон ячеек и масштабирует её под размер этого диапазона:


Sub PasteIntoRange()
    Dim ws As Worksheet
    Dim shp As Shape
    Dim shpCount As Long
    Dim r As Range
    
    On Error GoTo ErrHandler
    
    Set ws = ActiveSheet
    
    ' Проверяем, действительно ли выделены ячейки
    If TypeName(Selection) <> "Range" Then
        MsgBox "Пожалуйста, выделите ячейки перед вставкой изображения.", vbExclamation
        Exit Sub
    End If
    Set r = Selection
    
    ' Запоминаем текущее количество Shapes (фигур/изображений) на листе
    shpCount = ws.Shapes.Count
    
    ' Пробуем выполнить обычную вставку (Paste) из буфера обмена
    ws.Paste
    
    ' Если количество фигур не увеличилось, значит в буфере не было изображения
    If ws.Shapes.Count <= shpCount Then
        MsgBox "Изображение не найдено в буфере обмена или вставка не удалась.", vbExclamation
        Exit Sub
    End If
    
    ' Определяем последнее (новое) вставленное изображение
    Set shp = ws.Shapes(ws.Shapes.Count)
    
    ' Настраиваем размеры и позицию изображения в соответствии с выделенным диапазоном
    With shp
        .LockAspectRatio = msoTrue
        .Top = r.Top
        .Left = r.Left
        .Width = r.Width
        .Height = r.Height
    End With
    
    Exit Sub

ErrHandler:
    MsgBox "Произошла ошибка при вставке изображения.", vbExclamation
End Sub




Добавляем код в PERSONAL.XLSB
В редакторе VBA (Alt + F11) в области Project Explorer:
Раскрываем VBAProject (PERSONAL.XLSB).
Находим или создаём нужный Module (например, Module1).
Кликаем дважды по названию модуля, чтобы открыть его окно.
Вставляем туда текст макроса (копируем код выше и вставляем).
Нажимаем Ctrl + S, чтобы сохранить PERSONAL.XLSB.
4. Использование макроса PasteIntoRange
Теперь макрос находится в вашей Личной книге макросов. Он будет доступен каждый раз, когда вы запускаете Excel.

Открываем любую книгу Excel или создаём новую.
Выделяем диапазон ячеек, в границы которого хотим поместить изображение (например, A1:E10).
Копируем нужную картинку из Telegram или другого источника (правой кнопкой > «Копировать изображение»).
В Excel нажимаем Alt + F8, чтобы вызвать список макросов.
Выбираем PasteIntoRange (оно будет подписано как PERSONAL.XLSB!PasteIntoRange) и нажимаем Выполнить (Run).
Изображение вставится на лист и впишется в выбранный диапазон.
5. Привязка макроса к сочетанию клавиш (по желанию)
Чтобы не заходить каждый раз в окно макросов Alt + F8, можно назначить горячую клавишу:

В Excel снова жмём Alt + F8 для вызова окна «Макросы».
Выделяем макрос PasteIntoRange.
Нажимаем Параметры (Options).
В поле «Клавиши быстрого вызова» указываем желаемую комбинацию, например:
Ctrl + Shift + V.
Нажимаем OK. Теперь при каждом нажатии Ctrl + Shift + V будет запускаться наш макрос.
